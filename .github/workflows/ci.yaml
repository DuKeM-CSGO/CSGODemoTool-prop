name: CI
on:
  workflow_dispatch:
    inputs:
      build_debug:
        description: 'Build debug version'
        required: false
        type: boolean
        default: true
      build_release:
        description: 'Build release version'
        required: false
        type: boolean
        default: false
defaults:
  run:
    shell: pwsh
jobs:
  setup-matrix:
    runs-on: windows-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - name: Set Matrix
        id: set-matrix
        run: |
          $matrix = [System.Collections.Generic.List[object]]::new()
          if ("${{ inputs.build_debug }}" -eq "true") { $matrix.Add("debug") }
          if ("${{ inputs.build_release }}" -eq "true") { $matrix.Add("release") }
          $res = $matrix | ConvertTo-Json -AsArray -Compress
          "matrix=$res" |
            Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
  
  cmake:
    name: CMake
    needs: setup-matrix
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [windows-latest, ubuntu-latest, macos-latest]
        compiler: [msvc, gcc] #, clang]
        build_type: ${{ fromJson(needs.setup-matrix.outputs.matrix) }}
        exclude:
          - os: macos-latest
            compiler: msvc
          - os: ubuntu-latest
            compiler: msvc
    
    steps:
      - name: Run checkout
        uses: actions/checkout@v4
      
#     - name: Set build dir
#       id: set_build_dir
#       run: |
#         $build_dir = (Join-Path "${{ github.workspace }}" "build").ToString()
#         
#         if ($build_dir.Contains(" ")) {
#           Write-Warning "CMake working dir($build_dir) contains space"
#         }
#         
#         "build_dir=$build_dir" |
#           Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
      
      - name: CMake Workflow
        run: |
          $preset_array = @(
            "${{ matrix.compiler }}",
            "${{ matrix.build_type }}"
          )
          $preset = $preset_array -join "_"
          
          cmake --workflow --preset "$preset"
          
      - name: Find PWSH module dir
        if: matrix.os != 'windows-latest'
        id: find_pwsh_module_dir
        run: |
          Write-Output $env:PSModulePath
          
      - name: Cache PSWriteHTML module
        if: matrix.os != 'windows-latest'
        id: cache-module
        uses: actions/cache@v4
        with:
          path: ${{ env.DOC_PATH }}\PowerShell\Modules\PSWriteHTML
          key: ${{ runner.os }}-pswritehtml-v1
          restore-keys: |
            ${{ runner.os }}-
      
      - name: Install PSWriteHTML
        if: ${{ matrix.os != 'windows-latest' && steps.cache-module.outputs.cache-hit != 'true'}}
        shell: pwsh
        run: |
          Install-Module PSWriteHTML `
            -Scope CurrentUser `
            -Force `
            -AllowClobber `
            -Repository PSGallery
          
      - name: Gather result of CMake detecting
        id: cmake_detection
        run: |
          Import-Module MarkdownPS
          $markdown = ""
          
          $build_dir = "build"
          if ("${{ matrix.compiler }}" -ne "msvc") {
            if ("${{ matrix.build_type }}" -eq "debug") { $build_dir = "build/Debug" }
            else { $build_dir = "build/Release" }
          }
          
          $detect_result = Get-Content -Path $build_dir/cmake_detect.json -Raw -Encoding utf8 | ConvertFrom-Json
          
          # Format JSON
          $markdown = ""
          $emoji_yes = ":heavy_check_mark:"
          $emoji_no = ":x:"
          
          # CMake Detection
          
          $markdown += New-MDParagraph -Lines "CMake Detection"
          $markdown += $detect_result.cmake_variables.PSObject.Properties |
            Select-Object Name, Value |
            Sort-Object -Property name |
            New-MDTable -Shrink
          $markdown += New-MDParagraph -Lines ""
          
          # Compiler Flags
          
          $markdown += New-MDParagraph -Lines "Compiler Flags"
          $markdown += $detect_result.compiler_flags.PSObject.Properties |
            Select-Object Name, Value |
            Foreach-Object {
              [PSCustomObject]@{
                Name = $_.Name
                Value = if ( $null -ne $_.Value ) { "$emoji_yes" } else { "$emoji_no" }
              }
            } |
            Sort-Object -Property name |
            New-MDTable -Shrink
          $markdown += New-MDParagraph -Lines ""
          
          # C++ Features
          
          $markdown += New-MDParagraph -Lines "C++ Features"
          $markdown += $detect_result.cpp_features.PSObject.Properties |
            Select-Object Name, Value |
            Foreach-Object {
              [PSCustomObject]@{
                Name = $_.Name
                Value = if ( $null -ne $_.Value ) { "$emoji_yes" } else { "$emoji_no" }
              }
            } |
            Sort-Object -Property name |
            New-MDTable -Shrink
          $markdown += New-MDParagraph -Lines ""
          
          # Headers
          
          $markdown += New-MDParagraph -Lines "Headers"
          $markdown += $detect_result.headers.PSObject.Properties |
            Select-Object Name, Value |
            Foreach-Object {
              [PSCustomObject]@{
                Name = $_.Name
                Value = if ( $null -ne $_.Value ) { "$emoji_yes" } else { "$emoji_no" }
              }
            } |
            Sort-Object -Property name |
            New-MDTable -Shrink
          $markdown += New-MDParagraph -Lines ""
          
          $filename_array = @(
            "doc/auto_gen/cmake_detection",
            "${{ matrix.os }}",
            "${{ matrix.compiler }}",
            "${{ matrix.build_type }}"
          )
          $filename = $filename_array -join "_"
          $filename += ".md"
          $markdown | Out-File -FilePath "$filename" -Force -Encoding utf8
          
          # check changes
          
          git add .
          $changes = git status --porcelain
          
          if (-not $changes) {
              exit 0
          } else {
              "cmake_detection_changed=true" |
                Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
          }

      - name: Commit changes
        id: commit
        if: steps.cmake_detection.outputs.cmake_detection_changed == 'true'
        shell: pwsh
        run: |
          $commit_sha = git rev-parse HEAD
          "commit_sha=$commit_sha" |
            Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8

      - name: Create Pull Request
        if: steps.cmake_detection.outputs.cmake_detection_changed == 'true'
        uses: peter-evans/create-pull-request@v7
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          title: "Readme: updated to ${{ steps.commit.outputs.commit_sha }}"
          base: master
          branch: update-cmake_detection
          delete-branch: true
          author: github-actions[bot] <41898282+github-actions[bot]@users.noreply.github.com>
          commit-message: |
            Readme: updated to ${{ steps.commit.outputs.commit_sha }}
          body: |
            Readme: updated to ${{ steps.commit.outputs.commit_sha }}